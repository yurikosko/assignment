"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.restore = exports.serialize = exports.flatten = exports.isFixture = exports.isTest = void 0;
const lodash_1 = require("lodash");
const protocol_1 = require("../compiler/protocol");
const unit_type_1 = __importDefault(require("../../api/structure/unit-type"));
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const RECURSIVE_PROPERTIES = ['testFile', 'fixture', 'currentFixture', 'collectedTests'];
function isProperty(object, property) {
    return object.hasOwnProperty(property);
}
function isTest(value) {
    return value.unitType === unit_type_1.default.test;
}
exports.isTest = isTest;
function isFixture(value) {
    return value.unitType === unit_type_1.default.fixture;
}
exports.isFixture = isFixture;
function mapProperties(object, properties, mapper) {
    for (const property of properties) {
        if (!isProperty(object, property))
            continue;
        const value = object[property];
        if (Array.isArray(value))
            object[property] = value.map(item => mapper({ item, property, object }));
        else
            object[property] = mapper({ item: object[property], property, object });
    }
}
function replaceTestFunctions(unit) {
    mapProperties(unit, protocol_1.TEST_FUNCTION_PROPERTIES, ({ item }) => !!item);
}
function restoreTestFunctions(unit, mapper) {
    mapProperties(unit, protocol_1.TEST_FUNCTION_PROPERTIES, ({ item, object, property }) => item ? mapper(object.id, property) : item);
}
function flattenRecursiveProperties(unit) {
    mapProperties(unit, RECURSIVE_PROPERTIES, ({ item }) => item.id);
}
function restoreRecursiveProperties(unit, units) {
    mapProperties(unit, RECURSIVE_PROPERTIES, ({ item }) => units[item]);
}
function restoreRequestFilterRulesInHooks(test) {
    test.requestHooks.forEach(hook => {
        hook._requestFilterRules = testcafe_hammerhead_1.RequestFilterRule.from(hook._requestFilterRules);
    });
}
function flatten(tests) {
    const testFiles = lodash_1.uniq(tests.map(test => test.testFile));
    const fixtures = lodash_1.uniq(tests.map(test => test.fixture));
    return lodash_1.keyBy([...tests, ...fixtures, ...testFiles], unit => unit.id);
}
exports.flatten = flatten;
function serialize(units) {
    const result = {};
    for (const unit of Object.values(units)) {
        // @ts-ignore
        const copy = Object.assign({}, unit);
        replaceTestFunctions(copy);
        flattenRecursiveProperties(copy);
        result[copy.id] = copy;
    }
    return result;
}
exports.serialize = serialize;
function restore(units, mapper) {
    const list = Object.values(units);
    const result = [];
    for (const unit of list) {
        restoreRecursiveProperties(unit, units);
        restoreTestFunctions(unit, mapper);
    }
    for (const unit of list) {
        if (isTest(unit)) {
            restoreRequestFilterRulesInHooks(unit);
            result.push(unit);
        }
    }
    return result;
}
exports.restore = restore;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC1zdHJ1Y3R1cmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2VydmljZXMvc2VyaWFsaXphdGlvbi90ZXN0LXN0cnVjdHVyZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxtQ0FBcUM7QUFDckMsbURBQWdFO0FBS2hFLDhFQUFxRDtBQUNyRCw2REFBd0Q7QUFHeEQsTUFBTSxvQkFBb0IsR0FBRyxDQUFDLFVBQVUsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUsZ0JBQWdCLENBQVUsQ0FBQztBQXNCbEcsU0FBUyxVQUFVLENBQW9CLE1BQVMsRUFBRSxRQUFnQjtJQUM5RCxPQUFPLE1BQU0sQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDM0MsQ0FBQztBQUVELFNBQWdCLE1BQU0sQ0FBRSxLQUFXO0lBQy9CLE9BQU8sS0FBSyxDQUFDLFFBQVEsS0FBSyxtQkFBUSxDQUFDLElBQUksQ0FBQztBQUM1QyxDQUFDO0FBRkQsd0JBRUM7QUFFRCxTQUFnQixTQUFTLENBQUUsS0FBVztJQUNsQyxPQUFPLEtBQUssQ0FBQyxRQUFRLEtBQUssbUJBQVEsQ0FBQyxPQUFPLENBQUM7QUFDL0MsQ0FBQztBQUZELDhCQUVDO0FBRUQsU0FBUyxhQUFhLENBQTRELE1BQVMsRUFBRSxVQUFhLEVBQUUsTUFBNEI7SUFDcEksS0FBSyxNQUFNLFFBQVEsSUFBSSxVQUFVLEVBQUU7UUFDL0IsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDO1lBQzdCLFNBQVM7UUFFYixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFL0IsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztZQUNwQixNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBRSxR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bEMsTUFBTSxNQUFNLEdBQVcsRUFBRSxDQUFDO0lBRTFCLEtBQUssTUFBTSxJQUFJLElBQUksSUFBSSxFQUFFO1FBQ3JCLDBCQUEwQixDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN4QyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7S0FDdEM7SUFFRCxLQUFLLE1BQU0sSUFBSSxJQUFJLElBQUksRUFBRTtRQUNyQixJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNkLGdDQUFnQyxDQUFDLElBQVksQ0FBQyxDQUFDO1lBRS9DLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDckI7S0FFSjtJQUVELE9BQU8sTUFBTSxDQUFDO0FBQ2xCLENBQUM7QUFwQkQsMEJBb0JDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdW5pcSwga2V5QnkgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgVEVTVF9GVU5DVElPTl9QUk9QRVJUSUVTIH0gZnJvbSAnLi4vY29tcGlsZXIvcHJvdG9jb2wnO1xuXG5pbXBvcnQgVGVzdCBmcm9tICcuLi8uLi9hcGkvc3RydWN0dXJlL3Rlc3QnO1xuaW1wb3J0IEZpeHR1cmUgZnJvbSAnLi4vLi4vYXBpL3N0cnVjdHVyZS9maXh0dXJlJztcbmltcG9ydCBUZXN0RmlsZSBmcm9tICcuLi8uLi9hcGkvc3RydWN0dXJlL3Rlc3QtZmlsZSc7XG5pbXBvcnQgVW5pdFR5cGUgZnJvbSAnLi4vLi4vYXBpL3N0cnVjdHVyZS91bml0LXR5cGUnO1xuaW1wb3J0IHsgUmVxdWVzdEZpbHRlclJ1bGUgfSBmcm9tICd0ZXN0Y2FmZS1oYW1tZXJoZWFkJztcblxuXG5jb25zdCBSRUNVUlNJVkVfUFJPUEVSVElFUyA9IFsndGVzdEZpbGUnLCAnZml4dHVyZScsICdjdXJyZW50Rml4dHVyZScsICdjb2xsZWN0ZWRUZXN0cyddIGFzIGNvbnN0O1xuXG5pbnRlcmZhY2UgRnVuY3Rpb25NYXBwZXIge1xuICAgIChpZDogc3RyaW5nLCBmdW5jdGlvbk5hbWU6IHR5cGVvZiBURVNUX0ZVTkNUSU9OX1BST1BFUlRJRVNbbnVtYmVyXSk6IEZ1bmN0aW9uO1xufVxuXG5pbnRlcmZhY2UgTWFwcGVyQXJndW1lbnRzPFQsIFA+IHtcbiAgICBvYmplY3Q6IFQ7XG4gICAgcHJvcGVydHk6IFA7XG4gICAgaXRlbTogYW55O1xufVxuXG5pbnRlcmZhY2UgTWFwcGVyPFQsIFA+IHtcbiAgICAoeyBpdGVtLCBwcm9wZXJ0eSwgb2JqZWN0IH06IE1hcHBlckFyZ3VtZW50czxULCBQPik6IGFueTtcbn1cblxuZXhwb3J0IHR5cGUgVW5pdCA9IFRlc3QgfCBGaXh0dXJlIHwgVGVzdEZpbGU7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVW5pdHMge1xuICAgIFtpZDogc3RyaW5nXTogVW5pdDtcbn1cblxuZnVuY3Rpb24gaXNQcm9wZXJ0eTxUIGV4dGVuZHMgb2JqZWN0PiAob2JqZWN0OiBULCBwcm9wZXJ0eTogc3RyaW5nKTogcHJvcGVydHkgaXMgRXh0cmFjdDxrZXlvZiBULCBzdHJpbmc+IHtcbiAgICByZXR1cm4gb2JqZWN0Lmhhc093blByb3BlcnR5KHByb3BlcnR5KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzVGVzdCAodmFsdWU6IFVuaXQpOiB2YWx1ZSBpcyBUZXN0IHtcbiAgICByZXR1cm4gdmFsdWUudW5pdFR5cGUgPT09IFVuaXRUeXBlLnRlc3Q7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0ZpeHR1cmUgKHZhbHVlOiBVbml0KTogdmFsdWUgaXMgRml4dHVyZSB7XG4gICAgcmV0dXJuIHZhbHVlLnVuaXRUeXBlID09PSBVbml0VHlwZS5maXh0dXJlO1xufVxuXG5mdW5jdGlvbiBtYXBQcm9wZXJ0aWVzPFQgZXh0ZW5kcyBSZWFkb25seTxvYmplY3Q+LCBQIGV4dGVuZHMgUmVhZG9ubHk8c3RyaW5nW10+PiAob2JqZWN0OiBULCBwcm9wZXJ0aWVzOiBQLCBtYXBwZXI6IE1hcHBlcjxULCBQW251bWJlcl0+KTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiBwcm9wZXJ0aWVzKSB7XG4gICAgICAgIGlmICghaXNQcm9wZXJ0eShvYmplY3QsIHByb3BlcnR5KSlcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuXG4gICAgICAgIGNvbnN0IHZhbHVlID0gb2JqZWN0W3Byb3BlcnR5XTtcblxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpXG4gICAgICAgICAgICBvYmplY3RbcHJvcGVydHldID0gdmFsdWUubWFwKGl0ZW0gPT4gbWFwcGVyKHsgaXRlbSwgcHJvcGVydHksIG9iamVjdCB9KSkgYXMgYW55O1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICBvYmplY3RbcHJvcGVydHldID0gbWFwcGVyKHsgaXRlbTogb2JqZWN0W3Byb3BlcnR5XSwgcHJvcGVydHksIG9iamVjdCB9KTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHJlcGxhY2VUZXN0RnVuY3Rpb25zICh1bml0OiBVbml0KTogdm9pZCB7XG4gICAgbWFwUHJvcGVydGllcyh1bml0LCBURVNUX0ZVTkNUSU9OX1BST1BFUlRJRVMsICh7IGl0ZW0gfSkgPT4gISFpdGVtKTtcbn1cblxuZnVuY3Rpb24gcmVzdG9yZVRlc3RGdW5jdGlvbnMgKHVuaXQ6IFVuaXQsIG1hcHBlcjogRnVuY3Rpb25NYXBwZXIpOiB2b2lkIHtcbiAgICBtYXBQcm9wZXJ0aWVzKHVuaXQsIFRFU1RfRlVOQ1RJT05fUFJPUEVSVElFUywgKHsgaXRlbSwgb2JqZWN0LCBwcm9wZXJ0eSB9KSA9PiBpdGVtID8gbWFwcGVyKG9iamVjdC5pZCwgcHJvcGVydHkpIDogaXRlbSk7XG59XG5cbmZ1bmN0aW9uIGZsYXR0ZW5SZWN1cnNpdmVQcm9wZXJ0aWVzICh1bml0OiBVbml0KTogdm9pZCB7XG4gICAgbWFwUHJvcGVydGllcyh1bml0LCBSRUNVUlNJVkVfUFJPUEVSVElFUywgKHsgaXRlbSB9KSA9PiBpdGVtLmlkKTtcbn1cblxuZnVuY3Rpb24gcmVzdG9yZVJlY3Vyc2l2ZVByb3BlcnRpZXMgKHVuaXQ6IFVuaXQsIHVuaXRzOiBVbml0cyk6IHZvaWQge1xuICAgIG1hcFByb3BlcnRpZXModW5pdCwgUkVDVVJTSVZFX1BST1BFUlRJRVMsICh7IGl0ZW0gfSkgPT4gdW5pdHNbaXRlbV0pO1xufVxuXG5mdW5jdGlvbiByZXN0b3JlUmVxdWVzdEZpbHRlclJ1bGVzSW5Ib29rcyAodGVzdDogVGVzdCk6IHZvaWQge1xuICAgIHRlc3QucmVxdWVzdEhvb2tzLmZvckVhY2goaG9vayA9PiB7XG4gICAgICAgIGhvb2suX3JlcXVlc3RGaWx0ZXJSdWxlcyA9IFJlcXVlc3RGaWx0ZXJSdWxlLmZyb20oaG9vay5fcmVxdWVzdEZpbHRlclJ1bGVzIGFzIG9iamVjdFtdKTtcbiAgICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZsYXR0ZW4gKHRlc3RzOiBUZXN0W10pOiBVbml0cyB7XG4gICAgY29uc3QgdGVzdEZpbGVzID0gdW5pcSh0ZXN0cy5tYXAodGVzdCA9PiB0ZXN0LnRlc3RGaWxlKSk7XG4gICAgY29uc3QgZml4dHVyZXMgID0gdW5pcSh0ZXN0cy5tYXAodGVzdCA9PiB0ZXN0LmZpeHR1cmUpKTtcblxuICAgIHJldHVybiBrZXlCeShbLi4udGVzdHMsIC4uLmZpeHR1cmVzLCAuLi50ZXN0RmlsZXNdLCB1bml0ID0+IHVuaXQuaWQpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2VyaWFsaXplICh1bml0czogVW5pdHMpOiBVbml0cyB7XG4gICAgY29uc3QgcmVzdWx0OiBVbml0cyA9IHt9O1xuXG4gICAgZm9yIChjb25zdCB1bml0IG9mIE9iamVjdC52YWx1ZXModW5pdHMpKSB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgY29uc3QgY29weTogVW5pdCA9IHsgLi4udW5pdCB9O1xuXG4gICAgICAgIHJlcGxhY2VUZXN0RnVuY3Rpb25zKGNvcHkpO1xuICAgICAgICBmbGF0dGVuUmVjdXJzaXZlUHJvcGVydGllcyhjb3B5KTtcblxuICAgICAgICByZXN1bHRbY29weS5pZF0gPSBjb3B5O1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXN0b3JlICh1bml0czogVW5pdHMsIG1hcHBlcjogRnVuY3Rpb25NYXBwZXIpOiBUZXN0W10ge1xuICAgIGNvbnN0IGxpc3QgPSBPYmplY3QudmFsdWVzKHVuaXRzKTtcblxuICAgIGNvbnN0IHJlc3VsdDogVGVzdFtdID0gW107XG5cbiAgICBmb3IgKGNvbnN0IHVuaXQgb2YgbGlzdCkge1xuICAgICAgICByZXN0b3JlUmVjdXJzaXZlUHJvcGVydGllcyh1bml0LCB1bml0cyk7XG4gICAgICAgIHJlc3RvcmVUZXN0RnVuY3Rpb25zKHVuaXQsIG1hcHBlcik7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCB1bml0IG9mIGxpc3QpIHtcbiAgICAgICAgaWYgKGlzVGVzdCh1bml0KSkge1xuICAgICAgICAgICAgcmVzdG9yZVJlcXVlc3RGaWx0ZXJSdWxlc0luSG9va3ModW5pdCBhcyBUZXN0KTtcblxuICAgICAgICAgICAgcmVzdWx0LnB1c2godW5pdCk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG59XG4iXX0=